<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AutoScan360 - Central de Inteligencia Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <style>
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.98); backdrop-filter: blur(15px); }
        .active { display: flex; }
        .tab-active { border-bottom: 4px solid #3b82f6; color: white; font-weight: 900; }
        .btn-vanguardia { background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); transition: all 0.3s; }
        .btn-vanguardia:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(37, 99, 235, 0.4); }
        .card-negocio { background: rgba(30, 41, 59, 0.5); border: 1px solid rgba(255, 255, 255, 0.05); transition: all 0.3s; border-radius: 2.5rem; overflow: hidden; }
        .img-item { position: relative; height: 110px; }
        .btn-del { position: absolute; top: -5px; right: -5px; background: #ef4444; color: white; border-radius: 50%; width: 22px; height: 22px; font-size: 12px; font-weight: bold; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 2px solid #0f172a; z-index: 10; }
        ::-webkit-scrollbar { display: none; }
        /* Estilos para que parezca App en celular */
        body { -webkit-user-select: none; user-select: none; }
        input { -webkit-user-select: text; user-select: text; }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 antialiased font-sans">

    <div id="modal-inicio" class="modal active items-center justify-center p-4">
        <div class="bg-white text-slate-900 p-10 rounded-[3rem] max-w-xl shadow-2xl border-b-[15px] border-blue-600 text-center">
            <h2 class="text-4xl font-black mb-2 uppercase italic text-blue-600 tracking-tighter">AutoScan360</h2>
            <p class="text-[10px] text-slate-500 mb-8 font-bold uppercase tracking-widest italic text-blue-600">Central de Inteligencia de Mercado</p>
            <button onclick="document.getElementById('modal-inicio').classList.remove('active')" class="w-full btn-vanguardia text-white font-black py-6 rounded-2xl text-xl uppercase italic">Iniciar Escaneo</button>
        </div>
    </div>

    <header class="p-8 border-b border-white/5 bg-slate-900/50 sticky top-0 z-40 backdrop-blur-xl text-center">
        <h1 class="text-4xl font-black italic tracking-tighter text-blue-500">AUTOSCAN<span class="text-white">360</span></h1>
    </header>

    <main class="container mx-auto p-6 max-w-6xl">
        <section class="bg-slate-900 p-10 rounded-[3.5rem] shadow-2xl border border-white/5 mb-16">
            <h2 class="text-3xl font-black uppercase text-white mb-2 italic text-blue-600">Escanear Oportunidad</h2>
            <p id="st" class="text-blue-400 text-[10px] font-mono font-bold mb-10 uppercase italic tracking-tighter text-center">Priorizando Captura de Texto...</p>
            
            <input type="file" id="f" accept="image/*" class="hidden" multiple onchange="processFiles(event)">
            <label for="f" class="bg-white text-slate-950 font-black px-12 py-5 rounded-2xl cursor-pointer hover:bg-blue-50 transition-all mb-10 inline-block uppercase text-xs">Cargar Capturas de Venta</label>
            
            <div id="galeria-fotos" class="flex gap-4 overflow-x-auto mb-10 pb-2"></div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-left">
                <div class="space-y-2">
                    <label class="text-[9px] font-bold text-slate-500 ml-4 uppercase tracking-widest text-blue-600">VehÃ­culo (Marca/Modelo)</label>
                    <input type="text" id="m" class="w-full bg-slate-800 p-5 rounded-2xl outline-none border border-white/5 font-bold text-white uppercase text-sm" placeholder="Analizando...">
                </div>
                <div class="space-y-2">
                    <label class="text-[9px] font-bold text-slate-500 ml-4 uppercase tracking-widest text-blue-600">Precio Original</label>
                    <input type="number" id="pr" class="w-full bg-slate-800 p-5 rounded-2xl outline-none border border-white/5 font-bold text-green-400 text-xl" placeholder="0">
                </div>
                <div class="space-y-2">
                    <label class="text-[9px] font-bold text-slate-500 ml-4 uppercase tracking-widest text-blue-600">Kilometraje Detectado</label>
                    <input type="text" id="km" class="w-full bg-slate-800 p-5 rounded-2xl outline-none border border-white/5 font-bold text-blue-300 text-sm" placeholder="Ej: 85.000 KM">
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-left mt-6">
                <div class="space-y-2">
                    <label class="text-[9px] font-bold text-slate-500 ml-4 uppercase tracking-widest text-blue-600">AÃ±o</label>
                    <input type="number" id="a" class="w-full bg-slate-800 p-5 rounded-2xl outline-none border border-white/5 font-bold text-white text-sm">
                </div>
                <div class="space-y-2">
                    <label class="text-[9px] font-bold text-slate-500 ml-4 uppercase tracking-widest text-blue-600">DiagnÃ³stico IA</label>
                    <input type="text" id="stat" readonly class="w-full bg-slate-800/50 p-5 rounded-2xl font-bold text-blue-400 text-[10px] italic border border-white/5">
                </div>
            </div>
            
            <button onclick="save()" class="w-full mt-10 btn-vanguardia text-white font-black py-6 rounded-[2.5rem] text-xl shadow-2xl uppercase italic">Machetear y Guardar</button>
        </section>

        <div id="res-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 pb-20"></div>
    </main>

    <script>
        let dbV = JSON.parse(localStorage.getItem('as360_v')) || [];
        let galleryFiles = [];
        const MI_WHATSAPP = "5493512124265";

        async function processFiles(e){
            const files = Array.from(e.target.files);
            document.getElementById('st').innerText = "ðŸ¤– ESCANEANDO TEXTO TÃ‰CNICO...";

            for(let i=0; i<files.length; i++){
                const reader = new FileReader();
                reader.onload = (ev) => {
                    galleryFiles.push(ev.target.result);
                    renderGaleria();
                    if(i === 0) scanOCR(files[i]);
                };
                reader.readAsDataURL(files[i]);
            }
        }

        function renderGaleria() {
            const box = document.getElementById('galeria-fotos');
            box.innerHTML = "";
            galleryFiles.forEach((src, idx) => {
                box.innerHTML += `<div class="img-item min-w-[110px]"><div class="btn-del" onclick="removerFoto(${idx})">Ã—</div><img src="${src}" class="w-full h-full object-cover rounded-2xl border border-white/10 shadow-lg"></div>`;
            });
        }

        function removerFoto(idx) {
            galleryFiles.splice(idx, 1);
            renderGaleria();
        }

        function scanOCR(file){
            Tesseract.recognize(file, 'spa').then(({data:{text}})=>{
                document.getElementById('st').innerText = "âœ… DATOS FILTRADOS POR PRIORIDAD";
                const t = text.toLowerCase();
                
                const marcasModelos = ["peugeot", "toyota", "fiat", "volkswagen", "vw", "ford", "chevrolet", "honda", "renault", "nissan", "jeep", "siena", "cronos", "corolla", "hilux", "etios", "208", "207", "palio", "uno", "gol"];
                let lineas = text.split('\n').map(l => l.trim()).filter(l => l.length > 3);
                
                let modeloFinal = "";
                for(let l of lineas) {
                    const esNumeroLargo = /^\$?\s?[\d\.]+$/.test(l) && parseFloat(l.replace(/[$.]/g,'')) > 100000;
                    if(!esNumeroLargo && marcasModelos.some(m => l.toLowerCase().includes(m))) {
                        modeloFinal = l;
                        break;
                    }
                }
                if(!modeloFinal) modeloFinal = lineas.find(l => l.length > 5 && !/^\$?\s?[\d\.]+$/.test(l)) || "No Identificado";
                document.getElementById('m').value = modeloFinal.replace(/[|Â°Â¬!@#$%^&*()_+={}\[\]:;"'<>,.?\/\\]/g, "").substring(0,35).trim().toUpperCase();

                const kmMatch = t.match(/(\d+[\d\.]*)\s*(km|kms|mil|kilÃ³metros)/i);
                if(kmMatch) {
                    document.getElementById('km').value = kmMatch[1].replace(/\.$/, '') + " KM";
                } else {
                    const nums = t.match(/\b\d{2,3}\.?\d{3}\b/g);
                    if(nums) {
                        const valKm = nums.find(n => {
                            let v = parseInt(n.replace('.',''));
                            return v > 1000 && v < 350000 && v != document.getElementById('a').value;
                        });
                        if(valKm) document.getElementById('km').value = valKm + " KM";
                    }
                }

                const precios = t.match(/\b\d{1,3}\.?\d{3}\.?\d{3}\b|\b\d{5,8}\b/g) || [];
                let numsP = precios.map(p => parseFloat(p.replace(/\./g,''))).filter(n => n > 200000).sort((a,b)=>b-a);
                document.getElementById('pr').value = numsP[0] || "";

                document.getElementById('a').value = t.match(/\b(20|19)\d{2}\b/)?.[0] || "";
                document.getElementById('stat').value = numsP.length >= 2 ? "ðŸ”¥ OPORTUNIDAD" : "NOVEDAD";
            });
        }

        function save(){
            const item = { 
                id: Date.now(),
                m: document.getElementById('m').value, 
                a: document.getElementById('a').value, 
                km: document.getElementById('km').value, 
                pr: parseFloat(document.getElementById('pr').value) || 0, 
                imgs: [galleryFiles[0]], // Guardamos solo la principal para eficiencia
                s: document.getElementById('stat').value, 
                f: new Date().toLocaleDateString() 
            };
            if(!item.m || !item.pr) return alert("Completa Marca y Precio.");
            dbV.push(item);
            localStorage.setItem('as360_v', JSON.stringify(dbV));
            location.reload();
        }

        function eliminar(id) {
            if(confirm("Â¿Eliminar este registro?")) {
                dbV = dbV.filter(x => x.id !== id);
                localStorage.setItem('as360_v', JSON.stringify(dbV));
                location.reload();
            }
        }

        function compartir(v){
            const pF = Math.round(v.pr * 1.05);
            const msj = `*AUTOSCAN360*%0AðŸš— *${v.m.toUpperCase()}*%0AðŸ“… *AÃ‘O:* ${v.a}%0AðŸ›£ï¸ *KM:* ${v.km}%0AðŸ’° *VALOR:* $${pF.toLocaleString()}%0A%0AðŸ“² *INFO:* https://wa.me/${MI_WHATSAPP}`;
            window.open(`https://wa.me/?text=${msj}`, '_blank');
        }

        window.onload = () => {
            const grid = document.getElementById('res-grid');
            [...dbV].reverse().forEach(x => {
                grid.innerHTML += `
                    <div class="card-negocio shadow-xl">
                        <div class="relative h-48">
                            <img src="${x.imgs[0]}" class="w-full h-full object-cover">
                            <button onclick="eliminar(${x.id})" class="absolute top-2 right-2 bg-red-600 p-2 rounded-full text-white text-xs">âœ•</button>
                        </div>
                        <div class="p-6">
                            <h4 class="text-xl font-black uppercase text-white">${x.m}</h4>
                            <div class="text-2xl font-black text-blue-500 my-2">$${x.pr.toLocaleString()}</div>
                            <div class="text-[10px] text-slate-500 mb-6 uppercase">${x.km || ''} | ${x.a} | ${x.s}</div>
                            <button onclick='compartir(${JSON.stringify(x)})' class="w-full btn-vanguardia text-white font-black py-4 rounded-2xl text-[10px] uppercase">Enviar Propuesta</button>
                        </div>
                    </div>`;
            });
        };
    </script>
</body>
</html>